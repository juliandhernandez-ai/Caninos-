<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üêæ Mi Amigo el Bulldog Franc√©s</title>
    <!-- Incluir Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configuraci√≥n para usar la fuente Inter -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fc;
        }
        .bulldog-bg {
            background-color: #fff8e1; /* Color crema suave */
        }
        .btn-primary {
            @apply bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-xl transition duration-300 shadow-lg hover:shadow-xl;
        }
        .card {
            @apply bg-white p-6 rounded-2xl shadow-xl transition duration-300 hover:shadow-2xl border border-gray-100;
        }
    </style>
</head>
<body class="antialiased">

    <!-- Contenedor Principal Centrado -->
    <div class="max-w-4xl mx-auto py-10 px-4 sm:px-6 lg:px-8">

        <!-- Mensaje de Bienvenida -->
        <div id="welcome-message" class="card mb-10 text-center bulldog-bg animate-pulse">
            <h1 class="text-4xl font-extrabold text-indigo-800 mb-2">¬°Hola y Bienvenido/a! üëã</h1>
            <p class="text-xl text-indigo-600">
                Estamos encantados de que visites la p√°gina de nuestro peque√±o y valiente Bulldog Franc√©s. Prep√°rate para explorar el mundo de esta encantadora raza.
            </p>
        </div>

        <!-- SECCI√ìN 1: Descripci√≥n de la Raza -->
        <div class="card mb-10">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2">üê∂ El Bulldog Franc√©s: Un Encanto Incomparable</h2>
            <div class="flex flex-col md:flex-row gap-8">
                <!-- Imagen -->
                <div class="md:w-1/3 flex justify-center items-start">
                    <!-- Usamos la imagen subida por el usuario como ejemplo -->
                    <img src="Bulldog.jpg" alt="Bulldog Franc√©s" onerror="this.onerror=null;this.src='https://placehold.co/300x300/a395c5/ffffff?text=Bulldog+Franc√©s';" class="w-full max-w-xs md:max-w-full h-auto rounded-xl object-cover shadow-2xl border-4 border-indigo-200">
                </div>
                <!-- Descripci√≥n -->
                <div class="md:w-2/3">
                    <h3 class="text-2xl font-semibold text-indigo-600 mb-3">Caracter√≠sticas y Temperamento</h3>
                    <ul class="space-y-4 text-gray-700 list-disc pl-5">
                        <li>
                            <strong class="text-indigo-700">F√≠sicas:</strong> Son perros peque√±os y robustos, con una cabeza cuadrada y ancha, y su caracter√≠stica m√°s distintiva: las orejas de "murci√©lago" erguidas. Tienen un pelaje corto y brillante y una cola muy corta.
                        </li>
                        <li>
                            <strong class="text-indigo-700">Temperamento:</strong> Extremadamente cari√±osos, juguetones y c√≥micos. Son excelentes compa√±eros de vida, se adaptan bien a la vida en apartamento y disfrutan mucho de la compa√±√≠a humana. Suelen ser muy tranquilos, aunque pueden ser obstinados.
                        </li>
                        <li>
                            <strong class="text-indigo-700">Cuidados Esenciales:</strong> Requieren paseos moderados y no toleran bien el calor extremo debido a su hocico chato (braquic√©falo). Es crucial limpiar sus pliegues faciales regularmente para prevenir infecciones.
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- SECCI√ìN 2: B√∫squeda Interactiva y Costo -->
        <div class="card mb-10">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2">üîç Investiga la Raza y su Costo</h2>

            <!-- B√∫squeda Interactiva con Gemini API -->
            <div class="mb-6 p-4 border-2 border-indigo-100 rounded-lg bg-indigo-50">
                <h3 class="text-2xl font-semibold text-indigo-700 mb-3">B√∫squeda Avanzada de Variantes</h3>
                <p class="text-gray-600 mb-4">Usa este buscador para conocer m√°s sobre las variantes del Bulldog Franc√©s (colores, l√≠neas de sangre, cruces) o cualquier otra pregunta sobre la raza.</p>
                <input type="text" id="search-input" placeholder="Ej: 'Bulldog Franc√©s Blue Merle' o 'Mejor comida para Frenchie'" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 mb-3">
                <button id="search-button" class="btn-primary w-full">Buscar Informaci√≥n con Gemini</button>
                <div id="search-loading" class="mt-3 text-center text-indigo-600 hidden">
                    Cargando... üê∂
                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-indigo-500 inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </div>
                <div id="search-results" class="mt-4 p-4 border rounded-lg bg-white hidden">
                    <p class="font-bold text-indigo-600 mb-2">Resultados de la B√∫squeda:</p>
                    <div id="results-content" class="text-gray-700 prose max-w-none"></div>
                    <div id="results-sources" class="mt-3 text-sm text-gray-500"></div>
                </div>
            </div>

            <!-- Costo Promedio (Informaci√≥n Est√°tica) -->
            <div>
                <h3 class="text-2xl font-semibold text-indigo-700 mb-3">Costo Promedio de un Frenchie</h3>
                <div class="flex items-center space-x-4 bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                    <span class="text-4xl">üí∞</span>
                    <p class="text-lg text-gray-700">
                        El costo de un Bulldog Franc√©s de criadero responsable en Am√©rica Latina o Europa suele oscilar entre 
                        <strong class="text-yellow-700">1,500 y 4,000 USD</strong>, dependiendo de la l√≠nea de sangre, el color y la ubicaci√≥n.
                        Recuerda que los costos de mantenimiento (comida, veterinario, etc.) tambi√©n son significativos.
                    </p>
                </div>
            </div>
        </div>

        <!-- SECCI√ìN 3: Consejos de Protecci√≥n -->
        <div class="card mb-10">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2">üõ°Ô∏è Consejos de Protecci√≥n Esencial</h2>
            <div class="grid md:grid-cols-3 gap-6 text-center">
                <div class="p-4 rounded-xl bg-red-50 border border-red-200">
                    <span class="text-3xl mb-2 block">‚òÄÔ∏è</span>
                    <h4 class="font-bold text-red-700">Clima Caluroso</h4>
                    <p class="text-sm text-gray-600">Evita paseos en horas pico (10 AM - 4 PM). Siempre ofrece agua fresca y usa chalecos refrescantes. ¬°El golpe de calor es su mayor riesgo!</p>
                </div>
                <div class="p-4 rounded-xl bg-green-50 border border-green-200">
                    <span class="text-3xl mb-2 block">ü©∫</span>
                    <h4 class="font-bold text-green-700">Enfermedades</h4>
                    <p class="text-sm text-gray-600">Mant√©n al d√≠a todas las vacunas y desparasitaciones. Programa chequeos veterinarios semestrales, prestando especial atenci√≥n a sus problemas respiratorios y de piel.</p>
                </div>
                <div class="p-4 rounded-xl bg-blue-50 border border-blue-200">
                    <span class="text-3xl mb-2 block">üßò</span>
                    <h4 class="font-bold text-blue-700">Estr√©s/Ansiedad</h4>
                    <p class="text-sm text-gray-600">Son muy sensibles. Proporciona una rutina estable y juguetes de enriquecimiento. Evita dejarlos solos por per√≠odos muy largos para prevenir la ansiedad por separaci√≥n.</p>
                </div>
            </div>
        </div>

        <!-- SECCI√ìN 4: Encuesta de Satisfacci√≥n -->
        <div class="card mb-10">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2">üìä Encuesta de Satisfacci√≥n (Feedback Comunitario)</h2>
            <p class="text-gray-600 mb-4">¬øTienes o conoces un Bulldog Franc√©s? ¬°Dinos qu√© tan contento est√°s con la raza en general!</p>

            <div class="flex flex-col sm:flex-row justify-center items-center space-y-4 sm:space-y-0 sm:space-x-4">
                <button data-value="Muy Feliz" class="satisfaction-btn w-full sm:w-1/3 py-3 px-4 bg-green-500 hover:bg-green-600 text-white font-bold rounded-xl shadow-md transition duration-200">
                    üòÅ Muy Feliz
                </button>
                <button data-value="Satisfecho" class="satisfaction-btn w-full sm:w-1/3 py-3 px-4 bg-yellow-500 hover:bg-yellow-600 text-white font-bold rounded-xl shadow-md transition duration-200">
                    üòê Satisfecho
                </button>
                <button data-value="No Conforme" class="satisfaction-btn w-full sm:w-1/3 py-3 px-4 bg-red-500 hover:bg-red-600 text-white font-bold rounded-xl shadow-md transition duration-200">
                    üòû No Conforme
                </button>
            </div>

            <div id="survey-feedback" class="mt-4 p-3 text-center rounded-lg text-gray-700 bg-gray-100 hidden">
                ¬°Gracias por tu voto! Se ha registrado tu opini√≥n.
            </div>
            <div id="survey-counts" class="mt-4 text-center text-sm text-gray-500">
                Votos: Muy Feliz (<span id="count-Muy Feliz">0</span>), Satisfecho (<span id="count-Satisfecho">0</span>), No Conforme (<span id="count-No Conforme">0</span>)
            </div>
        </div>

        <!-- SECCI√ìN 5: Juego Interactivo - El Reto del Entrenador -->
        <div class="card mb-10">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2">üéÆ El Reto del Entrenador: Obediencia Canina</h2>
            <p class="text-gray-600 mb-4">¬°Ayuda a tu Frenchie a aprender una nueva orden! Haz clic en la orden y luego 'Entrenar' para ver si lo logra.</p>

            <div class="bg-indigo-50 p-6 rounded-xl border-2 border-indigo-200">
                <div class="flex flex-wrap gap-3 mb-5">
                    <button class="training-command py-2 px-4 bg-indigo-300 hover:bg-indigo-400 text-indigo-900 rounded-full font-semibold transition duration-200" data-command="Si√©ntate">Si√©ntate</button>
                    <button class="training-command py-2 px-4 bg-indigo-300 hover:bg-indigo-400 text-indigo-900 rounded-full font-semibold transition duration-200" data-command="Ven Aqu√≠">Ven Aqu√≠</button>
                    <button class="training-command py-2 px-4 bg-indigo-300 hover:bg-indigo-400 text-indigo-900 rounded-full font-semibold transition duration-200" data-command="Quiet@">Quiet@</button>
                    <button class="training-command py-2 px-4 bg-indigo-300 hover:bg-indigo-400 text-indigo-900 rounded-full font-semibold transition duration-200" data-command="Dame la Pata">Dame la Pata</button>
                </div>

                <div class="mb-4">
                    <p class="font-semibold text-indigo-800 mb-2">Orden Seleccionada:</p>
                    <div id="selected-command" class="text-xl font-extrabold text-indigo-900 p-2 border-dashed border-2 border-indigo-400 bg-white rounded-lg">
                        (Selecciona una orden de arriba)
                    </div>
                </div>

                <button id="train-button" class="btn-primary w-full py-4 text-xl disabled:opacity-50" disabled>
                    üêï ¬°Entrenar!
                </button>

                <div id="training-result" class="mt-4 p-4 text-center text-lg font-bold rounded-lg hidden"></div>
            </div>
        </div>

    </div>

    <script type="module">
        // ====================================================================
        // FIREBASE SETUP
        // ====================================================================

        // Variables globales proporcionadas por el entorno
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Inicializar Firebase
        let app, db, auth;
        let userId = null;
        let isAuthReady = false;

        if (firebaseConfig) {
            setLogLevel('Debug');
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // 1. Manejar autenticaci√≥n
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                } else {
                    try {
                        // Si no hay usuario, intentar iniciar sesi√≥n con el token personalizado o de forma an√≥nima
                        if (initialAuthToken) {
                             await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            const anonymousUser = await signInAnonymously(auth);
                            userId = anonymousUser.user.uid;
                        }
                    } catch (error) {
                        console.error("Error during authentication:", error);
                        // Fallback: usar un ID aleatorio si la autenticaci√≥n falla por completo
                        userId = crypto.randomUUID();
                    }
                }
                isAuthReady = true;
                // Una vez autenticado, cargar los datos de la encuesta
                if (db) {
                    setupSurveyListener();
                }
            });

        } else {
            console.error("Firebase config is missing.");
            userId = crypto.randomUUID(); // Usar ID aleatorio si no hay Firebase
            isAuthReady = true;
        }


        // ====================================================================
        // FUNCIONALIDAD DE ENCUESTA (Firestore)
        // ====================================================================

        const countElements = {
            "Muy Feliz": document.getElementById('count-Muy Feliz'),
            "Satisfecho": document.getElementById('count-Satisfecho'),
            "No Conforme": document.getElementById('count-No Conforme')
        };
        const surveyFeedback = document.getElementById('survey-feedback');
        const satisfactionButtons = document.querySelectorAll('.satisfaction-btn');

        function setupSurveyListener() {
            // Path: /artifacts/{appId}/public/data/satisfaction_votes
            const votesCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'satisfaction_votes');

            // Escuchar cambios en tiempo real en la colecci√≥n de votos
            onSnapshot(votesCollectionRef, async (snapshot) => {
                let counts = { "Muy Feliz": 0, "Satisfecho": 0, "No Conforme": 0 };
                
                // Procesar todos los documentos para obtener la cuenta total
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const vote = data.vote;
                    if (counts.hasOwnProperty(vote)) {
                        counts[vote]++;
                    }
                });

                // Actualizar la UI
                for (const vote in counts) {
                    if (countElements[vote]) {
                        countElements[vote].textContent = counts[vote];
                    }
                }
            }, (error) => {
                console.error("Error al escuchar votos:", error);
            });
        }

        satisfactionButtons.forEach(button => {
            button.addEventListener('click', async () => {
                if (!isAuthReady || !db) {
                    console.error("Firebase o autenticaci√≥n no est√°n listos.");
                    return;
                }

                const vote = button.getAttribute('data-value');

                try {
                    // Path: /artifacts/{appId}/public/data/satisfaction_votes/{docId}
                    const votesCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'satisfaction_votes');
                    
                    // A√±adir un nuevo documento con el voto
                    await addDoc(votesCollectionRef, {
                        userId: userId, // Usamos el userId para rastrear, aunque aqu√≠ se permite que cualquiera vote
                        vote: vote,
                        timestamp: new Date()
                    });
                    
                    // Mostrar feedback
                    surveyFeedback.textContent = `¬°Gracias! Votaste: ${vote}`;
                    surveyFeedback.classList.remove('hidden');
                    setTimeout(() => surveyFeedback.classList.add('hidden'), 3000);

                } catch (error) {
                    console.error("Error al guardar el voto:", error);
                    surveyFeedback.textContent = "Error al registrar el voto.";
                    surveyFeedback.classList.remove('hidden');
                    surveyFeedback.classList.add('bg-red-200');
                    setTimeout(() => {
                        surveyFeedback.classList.add('hidden');
                        surveyFeedback.classList.remove('bg-red-200');
                    }, 5000);
                }
            });
        });


        // ====================================================================
        // FUNCIONALIDAD DE JUEGO (Entrenamiento)
        // ====================================================================
        
        const commandButtons = document.querySelectorAll('.training-command');
        const selectedCommandDisplay = document.getElementById('selected-command');
        const trainButton = document.getElementById('train-button');
        const trainingResult = document.getElementById('training-result');
        let currentCommand = null;

        commandButtons.forEach(button => {
            button.addEventListener('click', () => {
                // Deseleccionar todos los botones
                commandButtons.forEach(btn => btn.classList.replace('bg-indigo-400', 'bg-indigo-300'));
                
                // Seleccionar el bot√≥n actual
                button.classList.replace('bg-indigo-300', 'bg-indigo-400');
                
                currentCommand = button.getAttribute('data-command');
                selectedCommandDisplay.textContent = currentCommand;
                trainButton.disabled = false;
                trainingResult.classList.add('hidden');
            });
        });

        trainButton.addEventListener('click', () => {
            if (!currentCommand) return;

            trainingResult.classList.remove('hidden');
            trainingResult.classList.remove('bg-green-100', 'bg-red-100');

            // L√≥gica de juego: el Frenchie es a veces obstinado
            const successRate = 0.65; // 65% de √©xito
            const success = Math.random() < successRate;

            if (success) {
                trainingResult.textContent = `¬°√âxito! üéâ Tu Frenchie ejecut√≥ la orden "${currentCommand}" a la perfecci√≥n. ¬°Dale una galleta! üç™`;
                trainingResult.classList.add('bg-green-100', 'text-green-800');
            } else {
                trainingResult.textContent = `Fallido. üò© Tu Frenchie te mira con cara de 'no, gracias'. Intenta con m√°s paciencia.`;
                trainingResult.classList.add('bg-red-100', 'text-red-800');
            }
        });


        // ====================================================================
        // FUNCIONALIDAD DE B√öSQUEDA (Gemini API)
        // ====================================================================

        const searchInput = document.getElementById('search-input');
        const searchButton = document.getElementById('search-button');
        const searchLoading = document.getElementById('search-loading');
        const searchResultsDiv = document.getElementById('search-results');
        const resultsContent = document.getElementById('results-content');
        const resultsSources = document.getElementById('results-sources');

        searchButton.addEventListener('click', performSearch);

        async function performSearch() {
            const userQuery = searchInput.value.trim();
            if (!userQuery) {
                resultsContent.innerHTML = '<p class="text-red-500">Por favor, introduce una consulta.</p>';
                searchResultsDiv.classList.remove('hidden');
                return;
            }

            // Mostrar el estado de carga
            searchResultsDiv.classList.add('hidden');
            searchLoading.classList.remove('hidden');
            resultsContent.innerHTML = '';
            resultsSources.innerHTML = '';

            const systemPrompt = "Act√∫a como un experto en razas caninas, enfocado espec√≠ficamente en Bulldogs Franceses. Proporciona una respuesta detallada, concisa y amigable, utilizando la informaci√≥n m√°s actualizada sobre la raza, sus variantes, salud o cuidados.";
            
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            // Funci√≥n de retardo para backoff exponencial
            const delay = ms => new Promise(res => setTimeout(res, ms));

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            const maxRetries = 3;
            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 && attempt < maxRetries - 1) {
                            const waitTime = Math.pow(2, attempt) * 1000;
                            await delay(waitTime);
                            continue; // Reintentar
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    const candidate = result.candidates?.[0];

                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        const text = candidate.content.parts[0].text;
                        let sources = [];
                        const groundingMetadata = candidate.groundingMetadata;
                        
                        if (groundingMetadata && groundingMetadata.groundingAttributions) {
                            sources = groundingMetadata.groundingAttributions
                                .map(attribution => ({
                                    uri: attribution.web?.uri,
                                    title: attribution.web?.title,
                                }))
                                .filter(source => source.uri && source.title);
                        }

                        // Mostrar el resultado
                        resultsContent.innerHTML = text.replace(/\n/g, '<br>');
                        
                        if (sources.length > 0) {
                            resultsSources.innerHTML = '<p class="font-semibold mt-3">Fuentes:</p>';
                            const ul = document.createElement('ul');
                            ul.className = 'list-disc pl-5 space-y-1';
                            sources.slice(0, 3).forEach(source => { // Mostrar solo las 3 primeras fuentes
                                const li = document.createElement('li');
                                li.innerHTML = `<a href="${source.uri}" target="_blank" class="text-indigo-500 hover:text-indigo-700">${source.title}</a>`;
                                ul.appendChild(li);
                            });
                            resultsSources.appendChild(ul);
                        }

                    } else {
                        resultsContent.innerHTML = '<p class="text-red-500">No se pudo obtener una respuesta. Int√©ntalo de nuevo.</p>';
                    }

                    // Ocultar carga y mostrar resultados
                    searchLoading.classList.add('hidden');
                    searchResultsDiv.classList.remove('hidden');
                    return;

                } catch (error) {
                    console.error('Error al llamar a la API de Gemini:', error);
                    searchLoading.classList.add('hidden');
                    resultsContent.innerHTML = `<p class="text-red-500">Ocurri√≥ un error en la b√∫squeda: ${error.message}</p>`;
                    searchResultsDiv.classList.remove('hidden');
                    return; // Salir del bucle de reintento
                }
            }
        }
    </script>
</body>
</html>
